# ==============================================================================
# 1. INGRESS STANDARD (Frontend e API pulite)
# ==============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tofork-ingress-standard
  namespace: tofork
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
spec:
  ingressClassName: nginx
  rules:
    - host: localhost
      http:
        paths:
          # --- GOOGLE AUTH (Priorit√† Alta) ---
          - path: /login/oauth2
            pathType: Prefix
            backend: { service: { name: user-service, port: { number: 8081 } } }
          - path: /oauth2
            pathType: Prefix
            backend: { service: { name: user-service, port: { number: 8081 } } }
          - path: /api/users
            pathType: Prefix
            backend: { service: { name: user-service, port: { number: 8081 } } }

          # --- ALTRE API ---
          - path: /api/restaurants
            pathType: Prefix
            backend: { service: { name: restaurant-service, port: { number: 8083 } } }
          - path: /api/bookings
            pathType: Prefix
            backend: { service: { name: booking-service, port: { number: 8085 } } }
          - path: /api/orders
            pathType: Prefix
            backend: { service: { name: order-service, port: { number: 8082 } } }
          - path: /api/menu-items
            pathType: Prefix
            backend: { service: { name: restaurant-service, port: { number: 8083 } } }
          - path: /api/payments
            pathType: Prefix
            backend: { service: { name: payment-service, port: { number: 8084 } } }

          # --- FRONTEND (Cattura tutto il resto, INCLUSO /auth) ---
          - path: /
            pathType: Prefix
            backend: { service: { name: frontend, port: { number: 3000 } } }

---

# ==============================================================================
# 2. INGRESS REWRITE (SOLO per /api/auth)
# ==============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tofork-ingress-rewrite
  namespace: tofork
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # Trasforma "/api/auth/login" in "/auth/login"
    nginx.ingress.kubernetes.io/rewrite-target: /auth/$2
spec:
  ingressClassName: nginx
  rules:
    - host: localhost
      http:
        paths:
          # REGEX CORRETTA E SPECIFICA
          # Cattura SOLO se inizia ESATTAMENTE con /api/auth
          # Il gruppo (.*) cattura "login", "register", ecc.
          - path: /api/auth(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: user-service
                port:
                  number: 8081